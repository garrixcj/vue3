# Package front-end static sources to nginx image
# 打包 image
.package_image:
  services:
    - docker:dind
  stage: package
  tags:
    - local-docker
  except:
    refs:
      - triggers
      - pipelines
    variables:
      - $CI_PROJECT_NAMESPACE =~ /fork/
  before_script:
    - |
      if [[ `test -d dist && echo "" || echo "error"` ]]
      then
          echo "dist not found"
          exit 1
      fi
    # Login docker registry
    - docker login -u ${QUAY_HUB_USER} -p ${QUAY_HUB_PASSWORD} ${QUAY_HUB}
  script:
    - ls -al
    # Prepare fe_admin image
    - IMAGE=${ADMIN_REPO}:${PLATFORM_NAME}-${APP_ENV}-${CI_COMMIT_SHORT_SHA}
    # build image
    - |
      docker build -q --pull --no-cache -t ${IMAGE} \
      --build-arg BASE_IMAGE=${NGINX_IMAGE} \
      --build-arg EXPIRES_TIME=${EXPIRES_TIME} \
      -f .gitlab-ci/.Dockerfile .
    # Show Image Info
    - docker run --rm ${IMAGE} nginx -v
    - docker run --rm ${IMAGE} ls -al /var/www/service/v3
    # Push Image To Hub
    - docker push ${IMAGE}

# 打包開發 image
package:image:dev:
  extends: .package_image
  needs: ["build:dist:dev"]
  only:
    refs:
      - dev
  variables:
    APP_ENV: dev
    EXPIRES_TIME: 1d

# 打包測試 image
package:image:qa:
  extends: .package_image
  needs: ["build:dist:qa"]
  only:
    refs:
      - qa
  variables:
    APP_ENV: qa
    EXPIRES_TIME: 3d

# 打包正式 image
package:image:prod:
  extends: .package_image
  needs: ["build:dist:prod"]
  only:
    - master
    - hotfix
  variables:
    APP_ENV: prod
    EXPIRES_TIME: 1w

# Package tgz for NAS
# 打包 tgz 檔
.package_tgz:
  stage: package
  tags:
    - local-docker
  except:
    refs:
      - triggers
      - pipelines
    variables:
      - $CI_PROJECT_NAMESPACE =~ /fork/
  script:
    - TGZ_NAME=${CI_PROJECT_NAME}.${APP_ENV}-${CI_COMMIT_SHORT_SHA}.tgz
    - tar zcf ${NAS_PATH}/${TGZ_NAME}_compressing dist/
    - mv ${NAS_PATH}/${TGZ_NAME}_compressing ${NAS_PATH}/${TGZ_NAME}

# 打包開發 tgz
package:tgz:dev:
  extends: .package_tgz
  needs: ["build:dist:dev"]
  only:
    refs:
      - dev
  variables:
    APP_ENV: dev

# 打包測試 tgz
package:tgz:qa:
  extends: .package_tgz
  needs: ["build:dist:qa"]
  only:
    refs:
      - qa
  variables:
    APP_ENV: qa

# 打包正式 tgz
package:tgz:prod:
  extends: .package_tgz
  needs: ["build:dist:prod"]
  only:
    refs:
      - hotfix
  variables:
    APP_ENV: prod

