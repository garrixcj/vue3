# Package front-end static sources to nginx image
# 打包 image
.package_image:
  services:
    - docker:dind
  stage: package
  tags:
    - gce-gitlab-runner-ssd
  image:
    name: gcr.io/google.com/cloudsdktool/cloud-sdk:353.0.0
    entrypoint:
      ['/bin/bash', '-c', 'ln -snf /bin/bash /bin/sh && /bin/bash -c $0']
  except:
    refs:
      - triggers
      - pipelines
    variables:
      - $CI_PROJECT_NAMESPACE =~ /fork/
  before_script:
    - |
      if [[ `test -d dist && echo "" || echo "error"` ]]
      then
          echo "dist not found"
          exit 1
      fi
    # Login docker registry
    - echo ${SERVICE_ACCOUNT_KEY} > $HOME/.config/key.json
    - gcloud auth activate-service-account ${SERVICE_ACCOUNT} --key-file=$HOME/.config/key.json
    - gcloud config set project gcp-20210526-001
    - gcloud auth configure-docker --quiet
    - gcloud auth configure-docker asia-east1-docker.pkg.dev --quiet
  script:
    - ls -al
    - IMAGE=asia-east1-docker.pkg.dev/gcp-20210526-001/platform/bbin-vector-${CI_PROJECT_NAME}-nginx:${APP_ENV}-${CI_COMMIT_SHORT_SHA}
    - IMAGE_LATEST=asia-east1-docker.pkg.dev/gcp-20210526-001/platform/bbin-vector-${CI_PROJECT_NAME}-nginx:${APP_ENV}-latest
    # build image
    - docker build -q --pull --no-cache -t ${IMAGE} -f .gitlab-ci/.Dockerfile .
    # Show Image Info
    - docker run --rm ${IMAGE} nginx -v
    - docker run --rm ${IMAGE} ls -al /var/www/service/v3
    # Push Image To Hub
    - docker push ${IMAGE}
    - docker tag ${IMAGE} ${IMAGE_LATEST}
    - docker push ${IMAGE_LATEST}

# 打包開發 image
package:image:dev:
  extends: .package_image
  only:
    - dev
  variables:
    APP_ENV: DEV
  dependencies:
    - build:dist:dev

# 打包測試 image
package:image:qa:
  extends: .package_image
  only:
    - qa
  variables:
    APP_ENV: QA
  dependencies:
    - build:dist:qa

# 打包正式 image
package:image:prod:
  extends: .package_image
  only:
    - master
    - hotfix
  variables:
    APP_ENV: Prod
  dependencies:
    - build:dist:prod
